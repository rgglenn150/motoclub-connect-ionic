<!-- Weather Widget Container with Flip Animation -->
<div class="weather-widget asphalt-secondary rounded-xl p-4"
     role="region"
     aria-label="Weather information widget"
     [class]="weatherBackgroundClass"
     [class.offline-mode]="!networkStatus.online"
     [class.poor-connection]="connectionQuality.quality === 'poor'"
     [class.flipped]="isFlipped"
     (click)="toggleFlip()"
     (keydown.enter)="toggleFlip()"
     (keydown.space)="toggleFlip()"
     tabindex="0"
     [attr.aria-label]="isFlipped ? 'Weather details view, press Enter or Space to return to main view' : 'Weather widget, press Enter or Space to view details'">
  
  <!-- Flip Container -->
  <div class="flip-container">
    <!-- Front Side (Main Weather View) -->
    <div class="flip-side flip-front" [class.hidden]="isFlipped">
      <!-- Network Status Indicator Bar (shows when offline or poor connection) -->
      <div *ngIf="statusMessage" class="network-status-bar mb-3 px-3 py-2 rounded-lg flex items-center space-x-2"
           [class.offline]="!networkStatus.online"
           [class.poor-connection]="connectionQuality.quality === 'poor'"
           [class.warning-connection]="connectionQuality.quality === 'fair'">
        <ion-icon [name]="networkStatusIcon" class="text-sm"></ion-icon>
        <span class="weather-network-status">{{ statusMessage }}</span>
      </div>

      <!-- Skeleton Loading State -->
      <div *ngIf="isLoading" class="skeleton-container">
        <div class="flex items-center justify-between">

          <!-- Weather Info Skeleton -->
          <div class="flex-1">
            <!-- Location name skeleton -->
            <div class="flex items-center justify-between mb-1">
              <div class="skeleton skeleton-location"></div>
              <div class="skeleton skeleton-refresh-btn"></div>
            </div>

            <!-- Temperature skeleton -->
            <div class="skeleton skeleton-temperature mb-1"></div>

            <!-- Condition and last updated skeleton -->
            <div class="flex items-center justify-between">
              <div class="skeleton skeleton-condition"></div>
              <div class="skeleton skeleton-time"></div>
            </div>

            <!-- Additional Weather Metrics Skeleton -->
            <div class="mt-3 flex items-center space-x-4">
              <div class="skeleton skeleton-metric"></div>
              <div class="skeleton skeleton-metric"></div>
              <div class="skeleton skeleton-metric"></div>
            </div>
          </div>

          <!-- Weather Icon Skeleton -->
          <div class="ml-4">
            <app-weather-svg-icon
              iconType="loading"
              size="large"
              [animated]="true">
            </app-weather-svg-icon>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div *ngIf="hasError && !isLoading" class="text-center">
        <div class="flex flex-col items-center space-y-3">
          <app-weather-svg-icon
            iconType="error"
            size="large"
            [animated]="true">
          </app-weather-svg-icon>
          <div>
            <p class="weather-error mb-2">{{ errorMessage }}</p>
            <!-- Enhanced retry button with network awareness -->
            <div class="flex flex-col space-y-2">
              <button
                *ngIf="canRefresh"
                (click)="refreshWeatherData(); $event.stopPropagation()"
                class="px-4 py-2 bg-amber-500 text-gray-900 rounded-lg weather-button hover:bg-amber-400 transition-colors"
                [class.opacity-50]="!canRefresh"
                type="button"
                aria-label="Retry loading weather data">
                <ion-icon name="refresh-outline" class="mr-1" aria-hidden="true"></ion-icon>
                Retry
              </button>
              <button
                *ngIf="!canRefresh && !networkStatus.online"
                disabled
                (click)="$event.stopPropagation()"
                class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg weather-button cursor-not-allowed"
                type="button"
                aria-label="Cannot refresh weather data - no internet connection">
                <ion-icon name="wifi-outline" class="mr-1" aria-hidden="true"></ion-icon>
                Connect to internet
              </button>
            </div>
            <!-- Connection tips for poor network -->
            <div *ngIf="connectionQuality.quality === 'poor'" class="mt-3 weather-timestamp text-gray-500">
              <p>ðŸ’¡ Try moving to an area with better signal</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Weather Data Display -->
      <div *ngIf="weatherData && !isLoading && !hasError" class="weather-data-container flex items-center justify-between">

        <!-- Weather Info -->
        <div class="flex-1">
          <!-- Header with location and network indicator -->
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center space-x-2">
              <p class="weather-location"
               role="text"
               [attr.aria-label]="'Location ' + locationName">{{ locationName }}</p>
              <!-- Data source indicator -->
              <div *ngIf="isUsingCachedData" class="data-source-indicator flex items-center">
                <ion-icon name="archive-outline" class="text-xs text-amber-400" title="Using cached data"></ion-icon>
              </div>
            </div>
            <!-- Enhanced refresh button with network state and location preferences -->
            <div class="flex items-center space-x-1">
              <!-- Location source indicator -->
              <div class="location-source-indicator flex items-center" [title]="locationSourceIndicator">
                <ion-icon [name]="locationSourceIcon" class="text-sm text-amber-400">
                </ion-icon>
              </div>
              <!-- Network quality indicator -->
              <div class="network-indicator flex items-center" [title]="connectionQuality.description">
                <ion-icon [name]="networkStatusIcon" class="text-sm"
                         [style.color]="'var(--ion-color-' + networkStatusColor + ')'">
                </ion-icon>
              </div>
              <!-- Location preferences button -->
              <button
                (click)="openLocationPreferences(); $event.stopPropagation()"
                class="settings-btn text-gray-400 hover:text-white transition-colors"
                type="button"
                aria-label="Open location preferences">
                <ion-icon name="settings-outline" class="text-lg" aria-hidden="true">
                </ion-icon>
              </button>
              <!-- Refresh button -->
              <button
                (click)="refreshWeatherData(); $event.stopPropagation()"
                class="refresh-btn text-gray-400 hover:text-white transition-colors"
                [class.disabled]="!canRefresh"
                [disabled]="!canRefresh"
                type="button"
                [attr.aria-label]="canRefresh ? 'Refresh weather data' : 'Cannot refresh - no internet connection'">
                <ion-icon name="refresh-outline" class="text-lg"
                         [class.animate-spin]="isLoading"
                         aria-hidden="true">
                </ion-icon>
              </button>
            </div>
          </div>

          <p class="weather-temperature mb-1"
             role="text"
             [attr.aria-label]="'Current temperature ' + temperatureText">{{ temperatureText }}</p>

          <!-- Condition and timestamp with data freshness -->
          <div class="flex items-center justify-between">
            <p class="weather-condition"
               role="text"
               [attr.aria-label]="'Weather condition ' + conditionText">{{ conditionText }}</p>
            <div *ngIf="lastUpdated" class="timestamp-container flex items-center space-x-2">
              <!-- Data freshness indicator -->
              <div class="data-freshness flex items-center space-x-1">
                <div class="freshness-dot" [class.fresh]="!isDataStale" [class.stale]="isDataStale"></div>
                <span class="weather-freshness">{{ dataFreshnessText }}</span>
              </div>
            </div>
          </div>

          <!-- Location source indicator -->
          <div class="location-source-info mt-1">
            <p class="weather-timestamp flex items-center">
              <ion-icon [name]="locationSourceIcon" class="mr-1 text-amber-400"></ion-icon>
              {{ locationSourceIndicator }}
            </p>
          </div>

          <!-- Enhanced metrics with connection awareness -->
          <div *ngIf="weatherData"
               class="mt-3 flex items-center space-x-4 weather-metrics"
               role="group"
               aria-label="Weather metrics">
            <span *ngIf="weatherData.metrics.humidity"
                  [attr.aria-label]="'Humidity ' + weatherData.metrics.humidity + ' percent'">
              <ion-icon name="water-outline" class="mr-1" aria-hidden="true"></ion-icon>
              <span class="metric-value">{{ weatherData.metrics.humidity }}%</span>
            </span>
            <span *ngIf="weatherData.metrics.windSpeed"
                  [attr.aria-label]="'Wind speed ' + weatherData.metrics.windSpeed + ' kilometers per hour'">
              <ion-icon name="leaf-outline" class="mr-1" aria-hidden="true"></ion-icon>
              <span class="metric-value">{{ weatherData.metrics.windSpeed }} km/h</span>
            </span>
            <span *ngIf="weatherData.temperature.feelsLike"
                  [attr.aria-label]="'Feels like ' + weatherData.temperature.feelsLike + ' degrees celsius'">
              <ion-icon name="thermometer-outline" class="mr-1" aria-hidden="true"></ion-icon>
              Feels <span class="metric-value">{{ weatherData.temperature.feelsLike }}Â°C</span>
            </span>
          </div>

          <!-- Cached data notice -->
          <div *ngIf="isUsingCachedData && !networkStatus.online"
               class="cached-data-notice mt-2 p-2 bg-orange-900/30 border border-orange-700/50 rounded-lg">
            <div class="flex items-center space-x-2">
              <ion-icon name="information-circle-outline" class="text-orange-400 text-sm"></ion-icon>
              <span class="weather-network-status text-orange-300">Showing offline data from {{ lastUpdatedText }}</span>
            </div>
          </div>
        </div>

        <!-- Weather Icon with connection state -->
        <div class="weather-icon-container ml-4 relative">
          <div class="weather-icon-wrapper" [class.opacity-75]="!networkStatus.online">
            <app-weather-svg-icon
              [iconType]="iconType"
              size="large"
              [animated]="true">
            </app-weather-svg-icon>
          </div>
          <!-- Offline indicator on weather icon -->
          <div *ngIf="!networkStatus.online" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
            <ion-icon name="wifi-outline" class="text-white text-xs" style="transform: rotate(180deg);"></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Side (Detailed Weather View) -->
    <div class="flip-side flip-back" [class.hidden]="!isFlipped" *ngIf="weatherData && !isLoading && !hasError">
      <!-- Header -->
      <div class="flip-header mb-4">
        <div class="flex items-center justify-between">
          <h3 class="weather-detail-title text-lg font-semibold text-white">
            <ion-icon name="information-circle-outline" class="mr-2" aria-hidden="true"></ion-icon>
            Weather Details
          </h3>
          <button
            class="flip-back-btn"
            (click)="toggleFlip(); $event.stopPropagation()"
            type="button"
            aria-label="Return to main weather view">
            <ion-icon name="arrow-back-outline" aria-hidden="true"></ion-icon>
          </button>
        </div>
        <p class="weather-detail-location text-sm text-gray-300 mt-1">{{ locationName }}</p>
      </div>

      <!-- Extended Forecast -->
      <div class="forecast-section mb-6">
        <h4 class="section-title mb-3">
          <ion-icon name="calendar-outline" class="mr-2" aria-hidden="true"></ion-icon>
          3-Day Forecast
        </h4>

        <!-- Forecast Available -->
        <div *ngIf="hasForecast" class="forecast-grid" role="group" aria-label="3-day weather forecast">
          <div *ngFor="let day of weatherData!.forecast; trackBy: trackForecastDay"
               class="forecast-item"
               [attr.aria-label]="day.dayName + ' forecast: ' + getForecastShortDescription(day.conditions.description) + ', high ' + day.temperature.max + ' degrees, low ' + day.temperature.min + ' degrees'">
            <div class="forecast-card">
              <!-- Day and Weather Icon -->
              <div class="forecast-header">
                <div class="forecast-day">{{ day.dayName }}</div>
                <div class="forecast-icon">
                  <app-weather-svg-icon
                    [iconType]="getForecastIconType(day.conditions.code)"
                    size="small"
                    [animated]="false"
                    [attr.aria-label]="day.conditions.description">
                  </app-weather-svg-icon>
                </div>
              </div>

              <!-- Weather Description -->
              <div class="forecast-condition">
                {{ getForecastShortDescription(day.conditions.description) }}
              </div>

              <!-- Temperature Range -->
              <div class="forecast-temperature">
                <span class="temp-high" [attr.aria-label]="'High ' + day.temperature.max + ' degrees'">{{ day.temperature.max }}Â°</span>
                <span class="temp-divider">â€¢</span>
                <span class="temp-low" [attr.aria-label]="'Low ' + day.temperature.min + ' degrees'">{{ day.temperature.min }}Â°</span>
              </div>

              <!-- Precipitation Chance (if available) -->
              <div *ngIf="day.precipitationChance !== undefined && day.precipitationChance > 0"
                   class="forecast-precipitation"
                   [attr.aria-label]="day.precipitationChance + ' percent chance of precipitation'">
                <ion-icon name="rainy-outline" class="precipitation-icon" aria-hidden="true"></ion-icon>
                <span class="precipitation-chance">{{ day.precipitationChance }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Forecast Loading State -->
        <div *ngIf="!hasForecast && isLoading" class="forecast-loading">
          <div class="forecast-skeleton">
            <div *ngFor="let i of [1,2,3]" class="forecast-skeleton-item">
              <div class="skeleton-day"></div>
              <div class="skeleton-icon"></div>
              <div class="skeleton-condition"></div>
              <div class="skeleton-temp"></div>
            </div>
          </div>
        </div>

        <!-- Forecast Unavailable -->
        <div *ngIf="!hasForecast && !isLoading" class="forecast-unavailable">
          <div class="unavailable-message">
            <div class="flex items-center justify-center space-x-2 text-center">
              <ion-icon name="calendar-clear-outline" class="text-gray-400 text-lg" aria-hidden="true"></ion-icon>
              <span class="text-sm text-gray-400">Forecast temporarily unavailable</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Conditions Details -->
      <div class="conditions-details">
        <h4 class="section-title mb-3">
          <ion-icon name="analytics-outline" class="mr-2" aria-hidden="true"></ion-icon>
          Current Conditions
        </h4>
        <div class="details-grid">
          <!-- Temperature Details -->
          <div class="detail-card">
            <div class="detail-header">
              <ion-icon name="thermometer-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">Temperature</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ temperatureText }}</p>
              <p class="detail-secondary" *ngIf="weatherData.temperature.feelsLike">
                Feels like {{ weatherData.temperature.feelsLike }}Â°C
              </p>
              <div class="detail-range" *ngIf="weatherData.temperature.min && weatherData.temperature.max">
                <span class="range-label">Range:</span>
                <span class="range-value">{{ weatherData.temperature.min }}Â° - {{ weatherData.temperature.max }}Â°</span>
              </div>
            </div>
          </div>

          <!-- Humidity -->
          <div class="detail-card" *ngIf="weatherData.metrics.humidity">
            <div class="detail-header">
              <ion-icon name="water-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">Humidity</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ weatherData.metrics.humidity }}%</p>
              <p class="detail-secondary">{{ getHumidityDescription(weatherData.metrics.humidity) }}</p>
            </div>
          </div>

          <!-- Wind -->
          <div class="detail-card" *ngIf="weatherData.metrics.windSpeed">
            <div class="detail-header">
              <ion-icon name="leaf-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">Wind</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ weatherData.metrics.windSpeed }} km/h</p>
              <p class="detail-secondary">{{ getWindDescription(weatherData.metrics.windSpeed) }}</p>
            </div>
          </div>

          <!-- Pressure -->
          <div class="detail-card" *ngIf="weatherData.metrics.pressure">
            <div class="detail-header">
              <ion-icon name="speedometer-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">Pressure</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ weatherData.metrics.pressure }} hPa</p>
              <p class="detail-secondary">{{ getPressureDescription(weatherData.metrics.pressure) }}</p>
            </div>
          </div>

          <!-- Visibility -->
          <div class="detail-card" *ngIf="weatherData.metrics.visibility">
            <div class="detail-header">
              <ion-icon name="eye-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">Visibility</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ weatherData.metrics.visibility }} km</p>
              <p class="detail-secondary">{{ getVisibilityDescription(weatherData.metrics.visibility) }}</p>
            </div>
          </div>

          <!-- UV Index -->
          <div class="detail-card" *ngIf="weatherData.metrics.uvIndex !== undefined">
            <div class="detail-header">
              <ion-icon name="sunny-outline" class="detail-icon" aria-hidden="true"></ion-icon>
              <span class="detail-label">UV Index</span>
            </div>
            <div class="detail-content">
              <p class="detail-primary">{{ weatherData.metrics.uvIndex }}</p>
              <p class="detail-secondary">{{ getUVIndexDescription(weatherData.metrics.uvIndex) }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Source and Freshness -->
      <div class="data-info mt-6 pt-4 border-t border-gray-600 border-opacity-50">
        <div class="flex items-center justify-between text-xs text-gray-400">
          <div class="flex items-center space-x-2">
            <ion-icon [name]="locationSourceIcon" class="text-amber-400" aria-hidden="true"></ion-icon>
            <span>{{ locationSourceIndicator }}</span>
          </div>
          <div class="flex items-center space-x-2">
            <div class="data-freshness flex items-center space-x-1">
              <div class="freshness-dot" [class.fresh]="!isDataStale" [class.stale]="isDataStale"></div>
              <span>{{ dataFreshnessText }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Accessibility Instructions -->
      <div class="sr-only" aria-live="polite">
        Weather details view is now displayed. Press Tab to navigate through the details, or press Enter or Space to return to the main view.
      </div>
    </div>
  </div>

</div>