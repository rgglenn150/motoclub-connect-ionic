<ion-header class="ion-no-border club-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>

  <div class="club-header-content">
    <div class="cover-photo-container">
      <img [src]="club.coverPhotoUrl" class="cover-photo" alt="Club Cover Photo"/>
      <div class="gradient-overlay"></div>
    </div>
    <ion-avatar class="club-avatar">
      <img [src]="club.logoUrl" alt="Club Logo"/>
    </ion-avatar>
    <div class="header-actions">
      <!-- Admin settings button (separate from join button for better UX) -->
      <ion-button *ngIf="isUserAdmin" fill="clear" color="light">
        <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
      </ion-button>
      <!-- Smart Join Button - Always visible with dynamic content -->
      <ion-button 
        [color]="getJoinButtonColor()" 
        shape="round" 
        [disabled]="isJoinButtonDisabled()"
        (click)="isJoinButtonActionable() ? joinClub() : null">
        
        <!-- Loading spinner -->
        <ion-spinner *ngIf="shouldShowSpinner()" name="crescent" size="small"></ion-spinner>
        
        <!-- Button icon (when not loading) -->
        <ion-icon 
          *ngIf="!shouldShowSpinner() && getJoinButtonIcon()" 
          [slot]="getJoinButtonText().length > 8 ? 'start' : 'icon-only'" 
          [name]="getJoinButtonIcon()">
        </ion-icon>
        
        <!-- Button text (when not icon-only) -->
        <span *ngIf="!shouldShowSpinner() && getJoinButtonText().length > 0" 
              [style.margin-left.px]="getJoinButtonIcon() && getJoinButtonText().length > 8 ? 8 : 0">
          {{ getJoinButtonText() }}
        </span>
        
        <!-- Loading text -->
        <span *ngIf="shouldShowSpinner()" style="margin-left: 8px;">
          {{ getJoinButtonText() }}
        </span>
      </ion-button>
    </div>
    <div class="club-info">
      <h1 class="club-name">{{ club.name }}</h1>
      <div class="club-meta">
        <ion-icon name="location-sharp"></ion-icon> {{ club.location }} &middot; {{ club.memberCount }} Members
      </div>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  <div *ngIf="isLoading || statusLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p *ngIf="isLoading && !statusLoading">Loading club details...</p>
    <p *ngIf="statusLoading && !isLoading">Checking membership status...</p>
    <p *ngIf="isLoading && statusLoading">Loading club details...</p>
  </div>
  
  <!-- Error State -->
  <div *ngIf="hasError" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger" size="large"></ion-icon>
    <h3>Unable to Load Club</h3>
    <p>{{ errorMessage }}</p>
    <ion-button color="primary" (click)="clubId && fetchClubData(clubId)">
      <ion-icon slot="start" name="refresh"></ion-icon>
      Try Again
    </ion-button>
  </div>
  
  <!-- Main Content -->
  <ng-container *ngIf="canViewContent && !isLoading && !hasError; else privateView">
    <ion-segment [value]="selectedTab" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="feed">
        <ion-label>Feed</ion-label>
      </ion-segment-button>
      <ion-segment-button value="members">
        <ion-label>Members</ion-label>
      </ion-segment-button>
      <ion-segment-button value="events">
        <ion-label>Events</ion-label>
      </ion-segment-button>
      <!-- Admin Only Tab -->
      <ion-segment-button value="manage" *ngIf="isUserAdmin">
        <ion-label>Manage</ion-label>
      </ion-segment-button>
    </ion-segment>

    <div [ngSwitch]="selectedTab">
      <div *ngSwitchCase="'feed'">
        <ion-card class="asphalt-card pinned-announcement" *ngIf="pinnedPost">
          <ion-card-header>
            <ion-card-subtitle class="pinned-subtitle">
              <ion-icon name="pin"></ion-icon> PINNED ANNOUNCEMENT
            </ion-card-subtitle>
            <ion-card-title>{{ pinnedPost.title }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>{{ pinnedPost.content }}</ion-card-content>
        </ion-card>
        <ion-card class="asphalt-card" *ngIf="upcomingRide">
          <div class="card-header-row">
            <div class="card-text">
              <ion-card-subtitle>UPCOMING RIDE &middot; {{ upcomingRide.date | date: 'MMM d, y' }}</ion-card-subtitle>
              <ion-card-title>{{ upcomingRide.title }}</ion-card-title>
            </div>
            <img [src]="upcomingRide.imageUrl" class="club-thumbnail" [alt]="upcomingRide.title"/>
          </div>
          <div class="card-footer">
            <div class="footer-item">
              <ion-icon name="location-sharp"></ion-icon>
              <span>{{ upcomingRide.location }}</span>
            </div>
            <div class="footer-item">
              <ion-icon name="people"></ion-icon>
              <span>{{ upcomingRide.attendeeCount }} Going</span>
            </div>
          </div>
        </ion-card>
      </div>

      <div *ngSwitchCase="'members'">
        <div class="members-section">
          <ion-card class="asphalt-card">
            <ion-card-header>
              <ion-card-title>Club Members ({{ club.memberCount }})</ion-card-title>
            </ion-card-header>
            <ion-card-content class="members-list">
              <ion-item *ngFor="let member of members" class="member-item">
                <ion-avatar slot="start">
                  <img [src]="member.avatarUrl" [alt]="member.name">
                </ion-avatar>
                <ion-label>
                  <h3>{{ member.name }}</h3>
                  <p>{{ member.role }}</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <div *ngSwitchCase="'events'">
        <div class="events-section">
          <ion-card class="asphalt-card" *ngFor="let event of events">
            <div class="card-header-row">
              <div class="card-text">
                <ion-card-subtitle>{{ event.type }} &middot; {{ event.date | date: 'MMM d, y' }}</ion-card-subtitle>
                <ion-card-title>{{ event.title }}</ion-card-title>
              </div>
              <img [src]="event.imageUrl" class="club-thumbnail" [alt]="event.title"/>
            </div>
            <div class="card-footer">
              <div class="footer-item">
                <ion-icon name="location-sharp"></ion-icon>
                <span>{{ event.location }}</span>
              </div>
              <div class="footer-item">
                <ion-icon name="people"></ion-icon>
                <span>{{ event.attendeeCount }} Going</span>
              </div>
            </div>
          </ion-card>
        </div>
      </div>

      <!-- Admin Management Tab -->
      <div *ngSwitchCase="'manage'">
        <div class="admin-section">
          
          <!-- Join Requests Section -->
          <ion-card class="asphalt-card">
            <ion-card-header>
              <div class="section-header">
                <ion-card-title>
                  <ion-icon name="person-add-outline"></ion-icon>
                  Join Requests
                </ion-card-title>
                <ion-badge *ngIf="joinRequests.length > 0" color="brand-amber">{{ joinRequests.length }}</ion-badge>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <!-- Loading State -->
              <div *ngIf="joinRequestsLoading" class="loading-state">
                <ion-spinner name="crescent" color="brand-amber"></ion-spinner>
                <p>Loading join requests...</p>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="!joinRequestsLoading && joinRequests.length === 0" class="empty-state">
                <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                <h4>No Pending Requests</h4>
                <p>All join requests have been processed.</p>
              </div>
              
              <!-- Join Requests List -->
              <div *ngIf="!joinRequestsLoading && joinRequests.length > 0">
                <ion-item *ngFor="let request of joinRequests" class="request-item">
                  <ion-avatar slot="start">
                    <img [src]="getAvatarUrl(request.user.profilePicture, request.user.name)" [alt]="request.user.name">
                  </ion-avatar>
                  <ion-label>
                    <h3>{{ request.user.name }}</h3>
                    <p>{{ request.user.email }}</p>
                    <p class="request-date">Requested {{ request.createdAt | date:'MMM d, y' }}</p>
                  </ion-label>
                  
                  <!-- Action Buttons -->
                  <div slot="end" class="request-actions">
                    <ion-button 
                      fill="clear" 
                      color="success" 
                      size="small"
                      [disabled]="isRequestProcessing(request._id)"
                      (click)="approveRequest(request)">
                      <ion-spinner *ngIf="isRequestProcessing(request._id)" name="crescent" size="small"></ion-spinner>
                      <ion-icon *ngIf="!isRequestProcessing(request._id)" name="checkmark-outline"></ion-icon>
                      <span *ngIf="!isRequestProcessing(request._id)">Approve</span>
                    </ion-button>
                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small"
                      [disabled]="isRequestProcessing(request._id)"
                      (click)="rejectRequest(request)">
                      <ion-spinner *ngIf="isRequestProcessing(request._id)" name="crescent" size="small"></ion-spinner>
                      <ion-icon *ngIf="!isRequestProcessing(request._id)" name="close-outline"></ion-icon>
                      <span *ngIf="!isRequestProcessing(request._id)">Reject</span>
                    </ion-button>
                  </div>
                </ion-item>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Members Management Section -->
          <ion-card class="asphalt-card">
            <ion-card-header>
              <div class="section-header">
                <ion-card-title>
                  <ion-icon name="people-outline"></ion-icon>
                  Members Management
                </ion-card-title>
                <ion-badge *ngIf="clubMembers.length > 0" color="primary">{{ clubMembers.length }}</ion-badge>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <!-- Loading State -->
              <div *ngIf="membersLoading" class="loading-state">
                <ion-spinner name="crescent" color="brand-amber"></ion-spinner>
                <p>Loading members...</p>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="!membersLoading && clubMembers.length === 0" class="empty-state">
                <ion-icon name="people-outline" color="medium"></ion-icon>
                <h4>No Members Found</h4>
                <p>Unable to load member list.</p>
              </div>
              
              <!-- Members List -->
              <div *ngIf="!membersLoading && clubMembers.length > 0">
                <ion-item *ngFor="let member of clubMembers" class="member-item">
                  <ion-avatar slot="start">
                    <img [src]="getAvatarUrl(member.user.profilePicture, member.user.name)" [alt]="member.user.name">
                  </ion-avatar>
                  <ion-label>
                    <h3>
                      {{ member.user.name }}
                      <ion-badge 
                        [color]="member.role === 'admin' ? 'success' : 'medium'" 
                        class="role-badge">
                        {{ member.role | titlecase }}
                      </ion-badge>
                    </h3>
                    <p>{{ member.user.email }}</p>
                    <p class="join-date">Member since {{ member.joinedAt | date:'MMM d, y' }}</p>
                  </ion-label>
                  
                  <!-- Member Actions -->
                  <ion-button 
                    *ngIf="member._id !== membershipData.memberId"
                    slot="end" 
                    fill="clear" 
                    color="medium"
                    [disabled]="isMemberProcessing(member._id)"
                    (click)="presentMemberActions(member)">
                    <ion-spinner *ngIf="isMemberProcessing(member._id)" name="crescent" size="small"></ion-spinner>
                    <ion-icon *ngIf="!isMemberProcessing(member._id)" name="ellipsis-vertical"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
            </ion-card-content>
          </ion-card>

        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #privateView>
    </ng-template>
</ion-content>

<ion-fab *ngIf="isUserAdmin" vertical="bottom" horizontal="end" slot="fixed">
  <ion-fab-button color="brand-amber">
    <ion-icon name="add-outline"></ion-icon>
  </ion-fab-button>
</ion-fab>