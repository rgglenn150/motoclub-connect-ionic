<ion-header class="ion-no-border club-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Skeleton Loader for Header -->
  <div *ngIf="isLoading || statusLoading" class="club-header-content skeleton-header">
    <div class="cover-photo-container">
      <ion-skeleton-text animated class="cover-photo-skeleton"></ion-skeleton-text>
      <div class="gradient-overlay"></div>
    </div>
    <ion-skeleton-text animated class="club-avatar-skeleton"></ion-skeleton-text>
    <div class="header-actions">
      <ion-skeleton-text animated class="join-button-skeleton"></ion-skeleton-text>
    </div>
    <div class="club-info">
      <ion-skeleton-text animated style="width: 70%; height: 32px; margin-bottom: 8px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 50%; height: 16px;"></ion-skeleton-text>
    </div>
  </div>

  <!-- Actual Header Content -->
  <div *ngIf="!isLoading && !statusLoading" class="club-header-content">
    <div class="cover-photo-container">
      <img [src]="club.coverPhotoUrl" class="cover-photo" alt="Club Cover Photo"/>
      <div class="gradient-overlay"></div>
    </div>
    <ion-avatar class="club-avatar">
      <img [src]="club.logoUrl" alt="Club Logo"/>
    </ion-avatar>
    <div class="header-actions">
      <!-- Admin settings button (separate from join button for better UX) -->
      <ion-button *ngIf="isUserAdmin" fill="clear" color="light">
        <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
      </ion-button>
      <!-- Smart Join Button - Always visible with dynamic content -->
      <ion-button 
        [color]="getJoinButtonColor()" 
        shape="round" 
        [disabled]="isJoinButtonDisabled()"
        [class.loading-button]="shouldShowSpinner()"
        (click)="isJoinButtonActionable() ? joinClub() : null">
        
        <!-- Loading spinner -->
        <ion-spinner *ngIf="shouldShowSpinner()" name="crescent" size="small"></ion-spinner>
        
        <!-- Button icon (when not loading) -->
        <ion-icon 
          *ngIf="!shouldShowSpinner() && getJoinButtonIcon()" 
          [slot]="getJoinButtonText().length > 8 ? 'start' : 'icon-only'" 
          [name]="getJoinButtonIcon()">
        </ion-icon>
        
        <!-- Button text (when not icon-only) -->
        <span *ngIf="!shouldShowSpinner() && getJoinButtonText().length > 0" 
              [style.margin-left.px]="getJoinButtonIcon() && getJoinButtonText().length > 8 ? 8 : 0">
          {{ getJoinButtonText() }}
        </span>
        
        <!-- Loading text -->
        <span *ngIf="shouldShowSpinner()" style="margin-left: 8px;">
          {{ getJoinButtonText() }}
        </span>
      </ion-button>
    </div>
    <div class="club-info">
      <h1 class="club-name">{{ club.name }}</h1>
      <div class="club-meta">
        <ion-icon name="location-sharp"></ion-icon> {{ club.location }} &middot; {{ club.memberCount }} Members
      </div>
    </div>
  </div>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Pull to refresh"
      refreshingSpinner="crescent"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Loading State - Only show when not refreshing -->
  <div *ngIf="(isLoading || statusLoading) && !isRefreshing" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p *ngIf="isLoading && !statusLoading">Loading club details...</p>
    <p *ngIf="statusLoading && !isLoading">Checking membership status...</p>
    <p *ngIf="isLoading && statusLoading">Loading club details...</p>
  </div>
  
  <!-- Error State -->
  <div *ngIf="hasError" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger" size="large"></ion-icon>
    <h3>Unable to Load Club</h3>
    <p>{{ errorMessage }}</p>
    <ion-button color="primary" (click)="clubId && fetchClubData(clubId)">
      <ion-icon slot="start" name="refresh"></ion-icon>
      Try Again
    </ion-button>
  </div>
  
  <!-- Skeleton Loader for Segments and Content -->
  <ng-container *ngIf="(isLoading || statusLoading) && !isRefreshing && !hasError">
    <!-- Skeleton Segment -->
    <div class="segment-skeleton">
      <ion-skeleton-text animated style="width: 100%; height: 48px; border-radius: 12px; margin: 20px;"></ion-skeleton-text>
    </div>

    <!-- Skeleton Content based on selected tab -->
    <div class="content-skeleton">
      <!-- Feed Skeleton -->
      <ion-card class="asphalt-card-skeleton">
        <div class="card-header-row">
          <div class="card-text">
            <ion-skeleton-text animated style="width: 40%; height: 16px; margin-bottom: 6px;"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 70%; height: 20px;"></ion-skeleton-text>
          </div>
          <ion-skeleton-text animated class="club-thumbnail-skeleton"></ion-skeleton-text>
        </div>
        <ion-skeleton-text animated style="width: 90%; margin: 8px 16px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 80%; margin: 0 16px 16px;"></ion-skeleton-text>
        <div class="footer-skeleton">
          <ion-skeleton-text animated style="width: 30%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 30%; height: 20px;"></ion-skeleton-text>
        </div>
      </ion-card>
      
      <!-- Another card -->
      <ion-card class="asphalt-card-skeleton">
        <div class="card-header-row">
          <div class="card-text">
            <ion-skeleton-text animated style="width: 50%; height: 16px; margin-bottom: 6px;"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 60%; height: 20px;"></ion-skeleton-text>
          </div>
          <ion-skeleton-text animated class="club-thumbnail-skeleton"></ion-skeleton-text>
        </div>
        <div class="footer-skeleton">
          <ion-skeleton-text animated style="width: 35%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 25%; height: 20px;"></ion-skeleton-text>
        </div>
      </ion-card>
    </div>
  </ng-container>

  <!-- Main Content -->
  <ng-container *ngIf="canViewContent && !isLoading && !hasError; else privateView">
    <ion-segment [value]="selectedTab" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="feed">
        <ion-label>Feed</ion-label>
      </ion-segment-button>
      <ion-segment-button value="members">
        <ion-label>Members</ion-label>
      </ion-segment-button>
      <ion-segment-button value="events">
        <ion-label>Events</ion-label>
      </ion-segment-button>
      <!-- Admin Only Tab -->
      <ion-segment-button value="manage" *ngIf="isUserAdmin">
        <ion-label>Manage</ion-label>
      </ion-segment-button>
    </ion-segment>

    <div [ngSwitch]="selectedTab">
      <div *ngSwitchCase="'feed'">
        <ion-card class="asphalt-card pinned-announcement" *ngIf="pinnedPost">
          <ion-card-header>
            <ion-card-subtitle class="pinned-subtitle">
              <ion-icon name="pin"></ion-icon> PINNED ANNOUNCEMENT
            </ion-card-subtitle>
            <ion-card-title>{{ pinnedPost.title }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>{{ pinnedPost.content }}</ion-card-content>
        </ion-card>
        
        <!-- Operation-specific error indicators -->
        <div *ngIf="operationErrors.clubData && canViewContent" class="operation-error">
          <ion-item lines="none" class="error-item">
            <ion-icon 
              [name]="getErrorIcon(operationErrors.clubData)" 
              [color]="getErrorColor(operationErrors.clubData)" 
              slot="start">
            </ion-icon>
            <ion-label>
              <h4>Club data may be outdated</h4>
              <p>{{ getErrorMessage(operationErrors.clubData) }}</p>
            </ion-label>
            <ion-button 
              *ngIf="shouldShowRetryButton(operationErrors.clubData)" 
              slot="end" 
              fill="clear" 
              size="small" 
              (click)="retryFetchClubData()">
              <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
          </ion-item>
        </div>
        <ion-card class="asphalt-card" *ngIf="upcomingRide">
          <div class="card-header-row">
            <div class="card-text">
              <ion-card-subtitle>UPCOMING RIDE &middot; {{ upcomingRide.date | date: 'MMM d, y' }}</ion-card-subtitle>
              <ion-card-title>{{ upcomingRide.title }}</ion-card-title>
            </div>
            <img [src]="upcomingRide.imageUrl" class="club-thumbnail" [alt]="upcomingRide.title"/>
          </div>
          <div class="card-footer">
            <div class="footer-item">
              <ion-icon name="location-sharp"></ion-icon>
              <span>{{ upcomingRide.location }}</span>
            </div>
            <div class="footer-item">
              <ion-icon name="people"></ion-icon>
              <span>{{ upcomingRide.attendeeCount }} Going</span>
            </div>
          </div>
        </ion-card>
      </div>

      <div *ngSwitchCase="'members'">
        <div class="members-section">
          <ion-card class="asphalt-card">
            <ion-card-header>
              <ion-card-title>Club Members ({{ club.memberCount }})</ion-card-title>
            </ion-card-header>
            <ion-card-content class="members-list">
              <ion-item *ngFor="let member of members" class="member-item">
                <ion-avatar slot="start">
                  <img [src]="member.avatarUrl" [alt]="member.name">
                </ion-avatar>
                <ion-label>
                  <h3>{{ member.name }}</h3>
                  <p>{{ member.role }}</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <div *ngSwitchCase="'events'">
        <div class="events-section">
          <ion-card class="asphalt-card" *ngFor="let event of events">
            <div class="card-header-row">
              <div class="card-text">
                <ion-card-subtitle>{{ event.type }} &middot; {{ event.date | date: 'MMM d, y' }}</ion-card-subtitle>
                <ion-card-title>{{ event.title }}</ion-card-title>
              </div>
              <img [src]="event.imageUrl" class="club-thumbnail" [alt]="event.title"/>
            </div>
            <div class="card-footer">
              <div class="footer-item">
                <ion-icon name="location-sharp"></ion-icon>
                <span>{{ event.location }}</span>
              </div>
              <div class="footer-item">
                <ion-icon name="people"></ion-icon>
                <span>{{ event.attendeeCount }} Going</span>
              </div>
            </div>
          </ion-card>
        </div>
      </div>

      <!-- Admin Management Tab -->
      <div *ngSwitchCase="'manage'">
        <div class="admin-section">
          
          <!-- Join Requests Section -->
          <ion-card class="asphalt-card">
            <ion-card-header>
              <div class="section-header">
                <ion-card-title>
                  <ion-icon name="person-add-outline"></ion-icon>
                  Join Requests
                </ion-card-title>
                <ion-badge *ngIf="joinRequests.length > 0" color="brand-amber">{{ joinRequests.length }}</ion-badge>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <!-- Join Operation Error State -->
              <div *ngIf="operationErrors.joinOperation" class="operation-error join-error">
                <ion-item lines="none" class="error-item">
                  <ion-icon 
                    [name]="getErrorIcon(operationErrors.joinOperation)" 
                    [color]="getErrorColor(operationErrors.joinOperation)" 
                    slot="start">
                  </ion-icon>
                  <ion-label>
                    <h4>Join Operation Failed</h4>
                    <p>{{ getErrorMessage(operationErrors.joinOperation) }}</p>
                  </ion-label>
                  <ion-button 
                    *ngIf="shouldShowRetryButton(operationErrors.joinOperation)" 
                    slot="end" 
                    fill="clear" 
                    size="small" 
                    color="primary"
                    (click)="retryJoinClub()"
                    [disabled]="isRetrying">
                    <ion-spinner *ngIf="isRetrying" name="crescent" size="small"></ion-spinner>
                    <ion-icon *ngIf="!isRetrying" name="refresh-outline"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
              
              <!-- Loading State with Skeleton -->
              <div *ngIf="joinRequestsLoading" class="loading-state">
                <!-- Skeleton for join requests -->
                <div class="requests-skeleton">
                  <ion-item class="request-item-skeleton" *ngFor="let i of [1,2]">
                    <ion-avatar slot="start">
                      <ion-skeleton-text animated></ion-skeleton-text>
                    </ion-avatar>
                    <ion-label>
                      <ion-skeleton-text animated style="width: 60%; height: 18px; margin-bottom: 4px;"></ion-skeleton-text>
                      <ion-skeleton-text animated style="width: 80%; height: 14px; margin-bottom: 2px;"></ion-skeleton-text>
                      <ion-skeleton-text animated style="width: 45%; height: 12px;"></ion-skeleton-text>
                    </ion-label>
                    <div slot="end" class="request-actions-skeleton">
                      <ion-skeleton-text animated style="width: 80px; height: 32px; border-radius: 8px; margin-right: 8px;"></ion-skeleton-text>
                      <ion-skeleton-text animated style="width: 70px; height: 32px; border-radius: 8px;"></ion-skeleton-text>
                    </div>
                  </ion-item>
                </div>
              </div>
              
              <!-- Admin Operations Error State -->
              <div *ngIf="operationErrors.adminOperations" class="operation-error admin-error">
                <ion-item lines="none" class="error-item">
                  <ion-icon 
                    [name]="getErrorIcon(operationErrors.adminOperations)" 
                    [color]="getErrorColor(operationErrors.adminOperations)" 
                    slot="start">
                  </ion-icon>
                  <ion-label>
                    <h4>Admin Operation Failed</h4>
                    <p>{{ getErrorMessage(operationErrors.adminOperations) }}</p>
                  </ion-label>
                  <ion-button 
                    *ngIf="shouldShowRetryButton(operationErrors.adminOperations)" 
                    slot="end" 
                    fill="clear" 
                    size="small" 
                    (click)="loadAdminData()"
                    [disabled]="isRetrying">
                    <ion-spinner *ngIf="isRetrying" name="crescent" size="small"></ion-spinner>
                    <ion-icon *ngIf="!isRetrying" name="refresh-outline"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="!joinRequestsLoading && joinRequests.length === 0 && !operationErrors.adminOperations" class="empty-state">
                <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                <h4>No Pending Requests</h4>
                <p>All join requests have been processed.</p>
              </div>
              
              <!-- Join Requests List -->
              <div *ngIf="!joinRequestsLoading && joinRequests.length > 0">
                <ion-item *ngFor="let request of joinRequests" class="request-item">
                  <ion-avatar slot="start">
                    <img [src]="getAvatarUrl(request.user.profilePicture, request.user.name)" [alt]="request.user.name">
                  </ion-avatar>
                  <ion-label>
                    <h3>{{ request.user.name }}</h3>
                    <p>{{ request.user.email }}</p>
                    <p class="request-date">Requested {{ request.createdAt | date:'MMM d, y' }}</p>
                  </ion-label>
                  
                  <!-- Action Buttons -->
                  <div slot="end" class="request-actions">
                    <ion-button 
                      fill="clear" 
                      color="success" 
                      size="small"
                      [disabled]="isRequestProcessing(request._id) || !networkStatus.online"
                      [class.loading-button]="isRequestProcessing(request._id)"
                      (click)="approveRequest(request)"
                      [attr.aria-label]="'Approve join request from ' + request.user.name">
                      <ion-spinner *ngIf="isRequestProcessing(request._id)" name="crescent" size="small"></ion-spinner>
                      <ion-icon *ngIf="!isRequestProcessing(request._id)" name="checkmark-outline"></ion-icon>
                      <span *ngIf="!isRequestProcessing(request._id)">Approve</span>
                      <span *ngIf="isRequestProcessing(request._id)" style="margin-left: 6px;">Processing...</span>
                    </ion-button>
                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small"
                      [disabled]="isRequestProcessing(request._id) || !networkStatus.online"
                      [class.loading-button]="isRequestProcessing(request._id)"
                      (click)="rejectRequest(request)"
                      [attr.aria-label]="'Reject join request from ' + request.user.name">
                      <ion-spinner *ngIf="isRequestProcessing(request._id)" name="crescent" size="small"></ion-spinner>
                      <ion-icon *ngIf="!isRequestProcessing(request._id)" name="close-outline"></ion-icon>
                      <span *ngIf="!isRequestProcessing(request._id)">Reject</span>
                      <span *ngIf="isRequestProcessing(request._id)" style="margin-left: 6px;">Processing...</span>
                    </ion-button>
                    
                    <!-- Offline indicator for this request -->
                    <ion-badge *ngIf="!networkStatus.online" color="warning" class="offline-badge">
                      <ion-icon name="cloud-offline-outline"></ion-icon>
                      Offline
                    </ion-badge>
                  </div>
                </ion-item>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Members Management Section -->
          <ion-card class="asphalt-card">
            <ion-card-header>
              <div class="section-header">
                <ion-card-title>
                  <ion-icon name="people-outline"></ion-icon>
                  Members Management
                </ion-card-title>
                <ion-badge *ngIf="clubMembers.length > 0" color="primary">{{ clubMembers.length }}</ion-badge>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <!-- Loading State with Skeleton -->
              <div *ngIf="membersLoading" class="loading-state">
                <!-- Skeleton for members -->
                <div class="members-skeleton">
                  <ion-item class="member-item-skeleton" *ngFor="let i of [1,2,3]">
                    <ion-avatar slot="start">
                      <ion-skeleton-text animated></ion-skeleton-text>
                    </ion-avatar>
                    <ion-label>
                      <ion-skeleton-text animated style="width: 50%; height: 18px; margin-bottom: 6px;"></ion-skeleton-text>
                      <ion-skeleton-text animated style="width: 70%; height: 14px; margin-bottom: 2px;"></ion-skeleton-text>
                      <ion-skeleton-text animated style="width: 40%; height: 12px;"></ion-skeleton-text>
                    </ion-label>
                    <ion-skeleton-text slot="end" animated style="width: 36px; height: 36px; border-radius: 50%;"></ion-skeleton-text>
                  </ion-item>
                </div>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="!membersLoading && clubMembers.length === 0" class="empty-state">
                <ion-icon name="people-outline" color="medium"></ion-icon>
                <h4>No Members Found</h4>
                <p>Unable to load member list.</p>
              </div>
              
              <!-- Members List -->
              <div *ngIf="!membersLoading && clubMembers.length > 0">
                <ion-item *ngFor="let member of clubMembers" class="member-item">
                  <ion-avatar slot="start">
                    <img [src]="getAvatarUrl(member.user.profilePicture, member.user.name)" [alt]="member.user.name">
                  </ion-avatar>
                  <ion-label>
                    <h3>
                      {{ member.user.name }}
                      <ion-badge 
                        [color]="member.role === 'admin' ? 'success' : 'medium'" 
                        class="role-badge">
                        {{ member.role | titlecase }}
                      </ion-badge>
                    </h3>
                    <p>{{ member.user.email }}</p>
                    <p class="join-date">Member since {{ member.joinedAt | date:'MMM d, y' }}</p>
                  </ion-label>
                  
                  <!-- Member Actions -->
                  <div slot="end" class="member-actions">
                    <ion-button 
                      *ngIf="member._id !== membershipData.memberId"
                      fill="clear" 
                      color="medium"
                      [disabled]="isMemberProcessing(member._id) || !networkStatus.online"
                      [class.loading-button]="isMemberProcessing(member._id)"
                      (click)="presentMemberActions(member)"
                      [attr.aria-label]="'Manage ' + member.user.name">
                      <ion-spinner *ngIf="isMemberProcessing(member._id)" name="crescent" size="small"></ion-spinner>
                      <ion-icon *ngIf="!isMemberProcessing(member._id)" name="ellipsis-vertical"></ion-icon>
                    </ion-button>
                    
                    <!-- Offline indicator -->
                    <ion-badge *ngIf="!networkStatus.online" color="warning" class="offline-badge">
                      <ion-icon name="cloud-offline-outline"></ion-icon>
                    </ion-badge>
                  </div>
                </ion-item>
              </div>
            </ion-card-content>
          </ion-card>

        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #privateView>
    </ng-template>
</ion-content>

<ion-fab *ngIf="isUserAdmin" vertical="bottom" horizontal="end" slot="fixed">
  <ion-fab-button color="brand-amber">
    <ion-icon name="add-outline"></ion-icon>
  </ion-fab-button>
</ion-fab>