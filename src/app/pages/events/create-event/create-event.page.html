<!-- 
  Create Event Page
  - Applies the "Asphalt UI" theme for a consistent look and feel.
  - Event creation form with all necessary fields for motorcycle club events
  - Uses reactive forms for proper validation
-->
<ion-header class="asphalt-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/clubs/' + clubId"></ion-back-button>
    </ion-buttons>
    <ion-title>Create Event</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="asphalt-background">
  <!-- Loading Spinner Overlay -->
  <app-loading-spinner [isLoading]="isLoading"></app-loading-spinner>
  
  <form [formGroup]="createEventForm" (ngSubmit)="createEvent()">
    <div class="ion-padding">

      <!-- Event Image Uploader -->
      <div class="image-uploader ion-text-center" (click)="fileInput.click()">
        <img *ngIf="eventImagePreview" [src]="eventImagePreview" class="event-image-preview" />
        <div *ngIf="!eventImagePreview" class="placeholder">
          <ion-icon name="camera-outline" class="placeholder-icon"></ion-icon>
          <ion-label>Upload Event Image</ion-label>
        </div>
        <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="ion-hide" />
      </div>

      <!-- Cropper Modal-like Section -->
      <div *ngIf="cropperVisible" class="cropper-container">
        <image-cropper
          [imageChangedEvent]="imageChangedEvent"
          [maintainAspectRatio]="true"
          [aspectRatio]="16 / 9"
          [resizeToWidth]="800"
          [imageQuality]="0.92"
          format="png"
          (imageCropped)="onImageCropped($event)"
          (cropperReady)="onCropperReady()"
          (loadImageFailed)="onCropperLoadImageFailed()"
        ></image-cropper>
        <div class="cropper-actions">
          <ion-button fill="clear" color="medium" (click)="cancelCrop()">Cancel</ion-button>
          <ion-button class="asphalt-button-primary" (click)="applyCrop()">Apply</ion-button>
        </div>
      </div>

      <!-- Event Name -->
      <ion-item class="asphalt-input-item" lines="none">
        <ion-icon name="calendar-outline" slot="start" class="asphalt-icon"></ion-icon>
        <ion-input formControlName="name" type="text" placeholder="Event Name"></ion-input>
      </ion-item>

      <!-- Event Description -->
      <ion-item class="asphalt-textarea-item" lines="none">
        <ion-textarea formControlName="description" placeholder="Event description, meeting points, what to bring..." [autoGrow]="true"></ion-textarea>
      </ion-item>

      <!-- Event Type -->
      <ion-item class="asphalt-select-item" lines="none">
        <ion-icon name="options-outline" slot="start" class="asphalt-icon"></ion-icon>
        <ion-select formControlName="eventType" placeholder="Select Event Type" interface="popover">
          <ion-select-option value="ride">ğŸï¸ Ride</ion-select-option>
          <ion-select-option value="meeting">ğŸ“‹ Meeting</ion-select-option>
          <ion-select-option value="meetup">â˜• Meetup</ion-select-option>
          <ion-select-option value="event">ğŸ‰ Event</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Event Privacy Toggle -->
      <ion-item class="asphalt-input-item privacy-toggle-item" lines="none">
        <ion-icon name="eye-outline" slot="start" class="asphalt-icon"></ion-icon>
        <ion-label>
          <h3>Event Visibility</h3>
          <p class="privacy-description">
            {{ createEventForm.get('isPrivate')?.value ?
               'Private - Only visible to club members' :
               'Public - Visible to all members in their events feed' }}
          </p>
        </ion-label>
        <ion-toggle
          formControlName="isPrivate"
          [checked]="true"
          slot="end">
        </ion-toggle>
      </ion-item>

      <!-- Start Date & Time -->
      <div class="date-field-container">
        <ion-item class="asphalt-datetime-item" lines="none">
          <ion-icon name="time-outline" slot="start" class="asphalt-icon"></ion-icon>
          <div class="datetime-content">
            <ion-label class="datetime-label">Start Date & Time *</ion-label>
            <ion-datetime-button datetime="start-datetime">
              <span class="datetime-value">{{ startDateTime ? (startDateTime | date:'medium') : 'Select start date and time' }}</span>
            </ion-datetime-button>
          </div>
        </ion-item>
      </div>
      <ion-modal [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime
            id="start-datetime"
            presentation="date-time"
            [min]="minDate"
            (ionChange)="onStartDateChange($event)"
          ></ion-datetime>
        </ng-template>
      </ion-modal>

      <!-- End Date & Time -->
      <div class="date-field-container">
        <ion-item class="asphalt-datetime-item optional-field" lines="none">
          <ion-icon name="time-outline" slot="start" class="asphalt-icon"></ion-icon>
          <div class="datetime-content">
            <ion-label class="datetime-label">End Date & Time <span class="optional-text">(Optional)</span></ion-label>
            <ion-datetime-button datetime="end-datetime">
              <span class="datetime-value">{{ endDateTime ? (endDateTime | date:'medium') : 'Select end date and time' }}</span>
            </ion-datetime-button>
          </div>
        </ion-item>
      </div>
      <ion-modal [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime
            id="end-datetime"
            presentation="date-time"
            [min]="minEndDate"
            (ionChange)="onEndDateChange($event)"
          ></ion-datetime>
        </ng-template>
      </ion-modal>

      <!-- Location -->
      <div class="location-field-container">
        <ion-icon name="location-outline" class="asphalt-icon location-icon"></ion-icon>
        <app-mapbox-autocomplete 
          formControlName="location" 
          placeholder="Meeting location or ride destination"
          (locationSelected)="onLocationSelected($event)">
        </app-mapbox-autocomplete>
      </div>

    </div>
  </form>
</ion-content>

<ion-footer class="asphalt-footer">
  <ion-toolbar>
    <ion-button 
      expand="block" 
      class="asphalt-button-primary" 
      (click)="createEvent()" 
      [disabled]="createEventForm.invalid || isLoading">
      Create Event
    </ion-button>
  </ion-toolbar>
</ion-footer>